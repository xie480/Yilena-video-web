<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yilena.service.dao.HistoryMapper">

    <insert id="addHistory">
        insert into history(id,entity_type,entity_id,created_time,user_id)
        values(#{id},#{entityType},#{entityId},#{createdTime},#{userId})
    </insert>
    <delete id="deleteHistory">
        delete from history where id = #{id}
    </delete>
    <delete id="deleteAllHistory">
        delete from history where user_id = #{userId}
    </delete>
    <delete id="deleteHistoryFifteenDaysAgo">
        DELETE FROM history
        WHERE (user_id, created_time) IN (
        SELECT user_id, created_time
        FROM history
        WHERE created_time &lt; DATE_SUB(NOW(), INTERVAL 15 DAY)
        )
    </delete>
    <select id="getHistoryByUserIdAndEntityId" resultType="com.yilena.service.entity.po.History">
        SELECT * FROM history
        WHERE user_id = #{userId}
          AND entity_id = #{entityId}
          AND entity_type = #{entityType}
          AND DATE(created_time) = CURDATE()
    </select>

    <resultMap id="historyResultMap" type="com.yilena.service.entity.dto.HistoryDTO">
        <result property="dateStr" column="dateStr"/>
        <result property="entityIds" column="entityIds"
                typeHandler="com.yilena.service.typeHandler.LongListTypeHandler"
                javaType="java.util.List"/>
        <result property="createTimes" column="createTimes"
                typeHandler="com.yilena.service.typeHandler.LocalDateTimeListTypeHandler"
                javaType="java.util.List"/>
        <result property="ids" column="ids"
                typeHandler="com.yilena.service.typeHandler.LongListTypeHandler"
                javaType="java.util.List"/>
    </resultMap>
    <select id="getHistory" resultMap="historyResultMap">
        SELECT
            dateStr,
            JSON_ARRAYAGG(entity_id) AS entityIds,
            JSON_ARRAYAGG(DATE_FORMAT(created_time, '%Y-%m-%d %H:%i:%s.%f')) AS createTimes,
            JSON_ARRAYAGG(ordered_history.id) as ids
            FROM (
                     SELECT
                         DATE_FORMAT(h.created_time, '%Y-%m-%d') AS dateStr,
                         h.entity_id AS entity_id,
                         h.created_time AS created_time,
                         h.id as id
                     FROM history h
                     WHERE h.user_id = #{userId}
                     ORDER BY h.created_time DESC
                 ) AS ordered_history
            GROUP BY dateStr
            ORDER BY dateStr DESC
    </select>
</mapper>
